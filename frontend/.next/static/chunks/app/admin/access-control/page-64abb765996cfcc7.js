(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4937],{1099:(e,s,r)=>{"use strict";r.d(s,{LQ:()=>i,uD:()=>n});var t=r(5155);r(2115);var a=r(8513);function i(e){let{feature:s,permission:r=a.Jj.VIEW,fallback:i=null,children:n,className:l}=e,{hasPermission:c,canAccessFeature:o}=(0,a.Sk)();return(r?c(s,r):o(s))?(0,t.jsx)("div",{className:l,children:n}):(0,t.jsx)("div",{className:l,children:i})}function n(e){let{feature:s,fallback:r=null,children:i,className:n}=e,{canAccessFeature:l}=(0,a.Sk)();return l(s)?(0,t.jsx)("div",{className:n,children:i}):(0,t.jsx)("div",{className:n,children:r})}},1230:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>M});var t=r(5155),a=r(2115),i=r(8513),n=r(5695);r(1099);let l={"/project-management":{feature:i.Gv.PROJECT_MANAGEMENT,permission:i.Jj.VIEW},"/project-management/create":{feature:i.Gv.PROJECT_MANAGEMENT,permission:i.Jj.CREATE},"/project-management/requests":{feature:i.Gv.WORK_REQUESTS,permission:i.Jj.VIEW},"/project-management/requests/create":{feature:i.Gv.WORK_REQUESTS,permission:i.Jj.CREATE},"/project-management/charters":{feature:i.Gv.PROJECT_CHARTER,permission:i.Jj.VIEW},"/project-management/charters/create":{feature:i.Gv.PROJECT_CHARTER,permission:i.Jj.CREATE},"/project-management/risks":{feature:i.Gv.RISK_MANAGEMENT,permission:i.Jj.VIEW},"/project-management/resources":{feature:i.Gv.RESOURCE_MANAGEMENT,permission:i.Jj.VIEW},"/work-requests":{feature:i.Gv.WORK_REQUESTS,permission:i.Jj.VIEW},"/work-requests/create":{feature:i.Gv.WORK_REQUESTS,permission:i.Jj.CREATE},"/access-control":{feature:i.Gv.ACCESS_CONTROL,permission:i.Jj.VIEW},"/user-management":{feature:i.Gv.USER_MANAGEMENT,permission:i.Jj.VIEW},"/tenant-management":{feature:i.Gv.TENANT_MANAGEMENT,permission:i.Jj.VIEW},"/system-settings":{feature:i.Gv.SYSTEM_SETTINGS,permission:i.Jj.VIEW},"/audit-logs":{feature:i.Gv.AUDIT_LOGS,permission:i.Jj.VIEW},"/reporting":{feature:i.Gv.REPORTING,permission:i.Jj.VIEW},"/dashboards":{feature:i.Gv.DASHBOARDS,permission:i.Jj.VIEW},"/analytics":{feature:i.Gv.ANALYTICS,permission:i.Jj.VIEW},"/migration-workbench":{feature:i.Gv.MIGRATION_WORKBENCH,permission:i.Jj.VIEW},"/file-upload":{feature:i.Gv.FILE_UPLOAD,permission:i.Jj.CREATE},"/data-validation":{feature:i.Gv.DATA_VALIDATION,permission:i.Jj.VIEW},"/benefits":{feature:i.Gv.BENEFITS_MANAGEMENT,permission:i.Jj.VIEW},"/payroll":{feature:i.Gv.PAYROLL_PROCESSING,permission:i.Jj.VIEW},"/employees":{feature:i.Gv.EMPLOYEE_RECORDS,permission:i.Jj.VIEW}},c=["/access-control","/user-management","/tenant-management","/system-settings","/audit-logs"],o=["/tenant-management","/system-settings"];function d(e){let{children:s,fallback:r,redirectTo:d="/dashboard"}=e,m=(0,n.usePathname)(),u=(0,n.useRouter)(),{hasPermission:x,isAdmin:g,isHostAdmin:h,isLoading:p,isAuthenticated:f,currentRole:j}=(0,i.Sk)(),[b,v]=(0,a.useState)(null),[y,N]=(0,a.useState)("");return((0,a.useEffect)(()=>{if(p)return void v(null);if(!f){v(!1),N("You must be logged in to access this page.");return}if(c.includes(m)&&!g()){v(!1),N("This page requires administrator privileges.");return}if(o.includes(m)&&!h()){v(!1),N("This page requires host administrator privileges.");return}let e=l[m];if(e&&!x(e.feature,e.permission)){v(!1),N("You don't have permission to ".concat(e.permission," ").concat(e.feature.replace("-"," "),"."));return}for(let e of[{pattern:/^\/work-requests\/[^\/]+$/,feature:i.Gv.WORK_REQUESTS,permission:i.Jj.VIEW},{pattern:/^\/work-requests\/[^\/]+\/edit$/,feature:i.Gv.WORK_REQUESTS,permission:i.Jj.UPDATE},{pattern:/^\/project-management\/requests\/[^\/]+$/,feature:i.Gv.WORK_REQUESTS,permission:i.Jj.VIEW},{pattern:/^\/project-management\/charters\/[^\/]+$/,feature:i.Gv.PROJECT_CHARTER,permission:i.Jj.VIEW}])if(e.pattern.test(m)){if(!x(e.feature,e.permission)){v(!1),N("You don't have permission to ".concat(e.permission," ").concat(e.feature.replace("-"," "),"."));return}break}v(!0),N("")},[m,x,g,h,p,f]),p||null===b)?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Checking permissions..."})]})}):b?(0,t.jsx)(t.Fragment,{children:s}):r?(0,t.jsx)(t.Fragment,{children:r}):(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsx)("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-6",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDD12"}),(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Access Denied"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6",children:y}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("button",{onClick:()=>u.push(d),className:"w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors",children:"Go to Dashboard"}),(0,t.jsx)("button",{onClick:()=>u.back(),className:"w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors",children:"Go Back"})]}),!1]})})})}var m=r(2539),u=r(4821),x=r(7159);function g(e){let{tenants:s,selectedTenant:r,onTenantChange:i,searchTerm:n,onSearchChange:l,loading:c=!1}=e,[o,d]=a.useState(!1);return(0,t.jsxs)("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsxs)("button",{onClick:()=>d(!o),disabled:c,className:"flex items-center space-x-2 px-4 py-2 bg-gray-50 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50",children:[(0,t.jsx)(m.A,{className:"h-4 w-4 text-gray-500"}),(0,t.jsx)("span",{className:"text-sm font-medium text-gray-900",children:r?r.name:"Select Tenant"}),(0,t.jsx)(u.A,{className:"h-4 w-4 text-gray-500"})]}),o&&(0,t.jsx)("div",{className:"absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-md shadow-lg z-50",children:(0,t.jsx)("div",{className:"max-h-60 overflow-y-auto",children:0===s.length?(0,t.jsx)("div",{className:"px-4 py-3 text-sm text-gray-500",children:"No tenants available"}):s.map(e=>(0,t.jsx)("button",{onClick:()=>{i(e),d(!1)},className:"w-full text-left px-4 py-3 text-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50 ".concat((null==r?void 0:r.id)===e.id?"bg-blue-50 text-blue-700 font-medium":"text-gray-900"),children:(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(m.A,{className:"h-4 w-4 text-gray-400"}),(0,t.jsx)("span",{children:e.name})]})},e.id))})})]}),r&&(0,t.jsxs)("div",{className:"text-sm text-gray-500",children:["Managing access for ",(0,t.jsx)("span",{className:"font-medium",children:r.name})]})]}),(0,t.jsx)("div",{className:"flex items-center space-x-4",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(x.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),(0,t.jsx)("input",{type:"text",placeholder:"Search users...",value:n,onChange:e=>l(e.target.value),className:"pl-10 pr-4 py-2 w-64 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})})]}),o&&(0,t.jsx)("div",{className:"fixed inset-0 z-40",onClick:()=>d(!1)})]})}var h=r(403),p=r(3408);function f(e){let{activeEntity:s,onEntityChange:r,userCount:a,roleCount:i}=e;return(0,t.jsx)("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:(0,t.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,t.jsxs)("button",{onClick:()=>r("users"),className:"flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ".concat("users"===s?"bg-blue-100 text-blue-700 border border-blue-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[(0,t.jsx)(h.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"Users"}),void 0!==a&&(0,t.jsx)("span",{className:"px-2 py-0.5 rounded-full text-xs ".concat("users"===s?"bg-blue-200 text-blue-800":"bg-gray-200 text-gray-600"),children:a})]}),(0,t.jsxs)("button",{onClick:()=>r("roles"),className:"flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ".concat("roles"===s?"bg-blue-100 text-blue-700 border border-blue-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[(0,t.jsx)(p.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"Roles"}),void 0!==i&&(0,t.jsx)("span",{className:"px-2 py-0.5 rounded-full text-xs ".concat("roles"===s?"bg-blue-200 text-blue-800":"bg-gray-200 text-gray-600"),children:i})]})]})})}var j=r(1032),b=r(6268),v=r(477),y=r(5915),N=r(2811),w=r(4139),E=r(9467),_=r(7447);let A=(0,j.FB)();function I(e){let{users:s,permissionCatalog:r,onCellClick:i,onUserClick:n,loading:l=!1,draftChanges:c=new Map}=e,[o,d]=(0,a.useState)(new Set),m=(0,a.useMemo)(()=>{let e=new Map;return r.forEach(s=>{e.has(s.resource)||e.set(s.resource,[]),e.get(s.resource).push(s)}),Array.from(e.entries()).map(e=>{let[s,r]=e;return{resource:s,permissions:r.sort((e,s)=>e.action.localeCompare(s.action))}})},[r]),x=e=>{let s=new Set(o);s.has(e)?s.delete(e):s.add(e),d(s)},g=(0,a.useMemo)(()=>{let e=[];return e.push(A.accessor("email",{id:"user",header:"User",size:250,cell:e=>{let{row:s}=e;return(0,t.jsxs)("div",{className:"flex items-center space-x-3 p-3 cursor-pointer hover:bg-gray-50",onClick:()=>n(s.original.userId),children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)("div",{className:"h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center",children:(0,t.jsx)(v.A,{className:"h-4 w-4 text-blue-600"})})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("div",{className:"text-sm font-medium text-gray-900 truncate",children:s.original.display_name||s.original.email}),(0,t.jsx)("div",{className:"text-xs text-gray-500 truncate",children:s.original.email}),(0,t.jsxs)("div",{className:"flex items-center space-x-2 mt-1",children:[(0,t.jsxs)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ".concat("host_admin"===s.original.role?"bg-purple-100 text-purple-800":"client_admin"===s.original.role?"bg-blue-100 text-blue-800":"program_manager"===s.original.role?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"),children:[(0,t.jsx)(p.A,{className:"h-3 w-3 mr-1"}),s.original.role.replace("_"," ")]}),!s.original.is_active&&(0,t.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800",children:"Inactive"})]})]})]})}})),m.forEach(s=>{let r=o.has(s.resource);e.push(A.display({id:"group-".concat(s.resource),header:()=>(0,t.jsx)("div",{className:"text-center",children:(0,t.jsxs)("button",{onClick:()=>x(s.resource),className:"flex items-center justify-center space-x-1 w-full p-2 hover:bg-gray-50 rounded",children:[r?(0,t.jsx)(u.A,{className:"h-4 w-4"}):(0,t.jsx)(y.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700 capitalize",children:s.resource.replace("-"," ")})]})}),size:120,cell:e=>{let{row:r}=e;return(0,t.jsx)("div",{className:"text-center p-2",children:(0,t.jsx)(k,{userId:r.original.userId,resource:s.resource,permissions:s.permissions,userCells:r.original.cells,onBulkChange:e=>{s.permissions.forEach(e=>{i(r.original.userId,e.permissionId)})}})})}})),r&&s.permissions.forEach(s=>{e.push(A.display({id:s.permissionId,header:()=>(0,t.jsx)("div",{className:"text-center p-2",children:(0,t.jsx)("div",{className:"text-xs font-medium text-gray-700 capitalize",children:s.action})}),size:80,cell:e=>{let{row:r}=e,a=r.original.cells.find(e=>e.permissionId===s.permissionId),n="".concat(r.original.userId,":").concat(s.permissionId),l=c.get(n);return(0,t.jsx)("div",{className:"text-center p-2",children:(0,t.jsx)(C,{cell:a,draftState:l,onClick:()=>i(r.original.userId,s.permissionId)})})}}))})}),e},[m,o,s,c,i,n]),h=(0,b.N4)({data:s,columns:g,getCoreRowModel:(0,j.HT)(),getFilteredRowModel:(0,j.hM)(),getSortedRowModel:(0,j.h5)()});return l?(0,t.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Loading permissions matrix..."})]})}):(0,t.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,t.jsx)("thead",{className:"bg-gray-50",children:h.getHeaderGroups().map(e=>(0,t.jsx)("tr",{children:e.headers.map(e=>(0,t.jsx)("th",{className:"px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ".concat("user"===e.id?"sticky left-0 bg-gray-50 z-10":""),style:{width:e.getSize()},children:e.isPlaceholder?null:(0,b.Kv)(e.column.columnDef.header,e.getContext())},e.id))},e.id))}),(0,t.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:h.getRowModel().rows.map(e=>(0,t.jsx)("tr",{className:"hover:bg-gray-50",children:e.getVisibleCells().map(e=>(0,t.jsx)("td",{className:"px-2 py-1 whitespace-nowrap text-sm text-gray-900 ".concat("user"===e.column.id?"sticky left-0 bg-white z-10":""),style:{width:e.column.getSize()},children:(0,b.Kv)(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})]})}),0===s.length&&(0,t.jsxs)("div",{className:"text-center py-12",children:[(0,t.jsx)(v.A,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,t.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No users found"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Select a tenant to view users and their permissions."})]})]})}function C(e){let{cell:s,draftState:r,onClick:a}=e,i=r||(null==s?void 0:s.state)||"none",n=(null==s?void 0:s.origin)||"none",l=void 0!==r;return(0,t.jsx)("button",{onClick:a,className:"w-8 h-8 rounded border flex items-center justify-center hover:opacity-80 transition-all ".concat((()=>{if(l)switch(i){case"allow":return"bg-green-200 text-green-800 border-green-300 ring-2 ring-green-400";case"deny":return"bg-red-200 text-red-800 border-red-300 ring-2 ring-red-400";default:return"bg-gray-200 text-gray-600 border-gray-300 ring-2 ring-gray-400"}switch(i){case"allow":return"role"===n?"bg-green-100 text-green-700 border-green-200":"bg-green-500 text-white border-green-600";case"deny":return"role"===n?"bg-red-100 text-red-700 border-red-200":"bg-red-500 text-white border-red-600";default:return"bg-gray-100 text-gray-500 border-gray-200"}})()),title:"".concat(i," (").concat(n).concat((null==s?void 0:s.roleNames)?" - ".concat(s.roleNames.join(", ")):"",")"),children:(()=>{switch(i){case"allow":return(0,t.jsx)(N.A,{className:"h-4 w-4"});case"deny":return(0,t.jsx)(w.A,{className:"h-4 w-4"});default:return(0,t.jsx)(E.A,{className:"h-4 w-4"})}})()})}function k(e){let{userId:s,resource:r,permissions:a,userCells:i,onBulkChange:n}=e,l=i.filter(e=>a.some(s=>s.permissionId===e.permissionId)),c=l.filter(e=>"allow"===e.state).length,o=l.filter(e=>"deny"===e.state).length,d=l.length,m=c===d?"allow":o===d?"deny":c>0||o>0?"mixed":"none";return(0,t.jsx)("button",{onClick:()=>n("allow"===m?"none":"allow"),className:"w-8 h-8 rounded border flex items-center justify-center hover:opacity-80 transition-all ".concat((()=>{switch(m){case"allow":return"bg-green-100 text-green-700 border-green-200";case"deny":return"bg-red-100 text-red-700 border-red-200";case"mixed":return"bg-yellow-100 text-yellow-700 border-yellow-200";default:return"bg-gray-100 text-gray-500 border-gray-200"}})()),title:"Bulk ".concat(r,": ").concat(c,"/").concat(d," allowed"),children:(()=>{switch(m){case"allow":return(0,t.jsx)(N.A,{className:"h-4 w-4"});case"deny":return(0,t.jsx)(w.A,{className:"h-4 w-4"});case"mixed":return(0,t.jsx)(_.A,{className:"h-4 w-4"});default:return(0,t.jsx)(E.A,{className:"h-4 w-4"})}})()})}var S=r(8156);function R(e){let{isOpen:s,onClose:r,userDetail:a,userPermissions:i,onPermissionToggle:n,onRevertOverride:l,loading:c=!1}=e;if(!s)return null;let o=i.filter(e=>"override"===e.origin),d=i.filter(e=>"role"===e.origin&&"allow"===e.state);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:r}),(0,t.jsxs)("div",{className:"fixed right-0 top-0 h-full w-96 bg-white shadow-xl z-50 overflow-y-auto",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"User Permissions"}),(0,t.jsx)("button",{onClick:r,className:"p-2 hover:bg-gray-100 rounded-md",children:(0,t.jsx)(w.A,{className:"h-5 w-5 text-gray-500"})})]}),c?(0,t.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a?(0,t.jsxs)("div",{className:"p-6 space-y-6",children:[(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3 mb-3",children:[(0,t.jsx)("div",{className:"h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center",children:(0,t.jsx)(v.A,{className:"h-5 w-5 text-blue-600"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-gray-900",children:a.profile.first_name&&a.profile.last_name?"".concat(a.profile.first_name," ").concat(a.profile.last_name):a.profile.email}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:a.profile.email})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(p.A,{className:"h-4 w-4 text-gray-400"}),(0,t.jsx)("span",{className:"text-gray-600",children:"Role:"}),(0,t.jsx)("span",{className:"font-medium",children:a.membership.role.replace("_"," ")})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(m.A,{className:"h-4 w-4 text-gray-400"}),(0,t.jsx)("span",{className:"text-gray-600",children:"Status:"}),(0,t.jsx)("span",{className:"font-medium ".concat(a.membership.is_active?"text-green-600":"text-red-600"),children:a.membership.is_active?"Active":"Inactive"})]})]})]}),o.length>0&&(0,t.jsxs)("div",{children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-gray-900 mb-3 flex items-center",children:[(0,t.jsx)(S.A,{className:"h-4 w-4 text-orange-500 mr-2"}),"Permission Overrides (",o.length,")"]}),(0,t.jsx)("div",{className:"space-y-2",children:o.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-3 bg-orange-50 border border-orange-200 rounded-md",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"text-sm font-medium text-gray-900",children:[e.resource.replace("-"," ")," - ",e.action]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["Override: ",e.state]})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("div",{className:"w-6 h-6 rounded flex items-center justify-center ".concat("allow"===e.state?"bg-green-500 text-white":"deny"===e.state?"bg-red-500 text-white":"bg-gray-400 text-white"),children:"allow"===e.state?(0,t.jsx)(N.A,{className:"h-3 w-3"}):"deny"===e.state?(0,t.jsx)(w.A,{className:"h-3 w-3"}):(0,t.jsx)(E.A,{className:"h-3 w-3"})}),(0,t.jsx)("button",{onClick:()=>l(e.permissionId),className:"text-xs text-blue-600 hover:text-blue-800",children:"Revert"})]})]},e.permissionId))})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-gray-900 mb-3 flex items-center",children:[(0,t.jsx)(p.A,{className:"h-4 w-4 text-blue-500 mr-2"}),"Role Permissions (",d.length,")"]}),(0,t.jsx)("div",{className:"space-y-1 max-h-64 overflow-y-auto",children:d.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded-md",children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)("div",{className:"text-sm text-gray-900",children:[e.resource.replace("-"," ")," - ",e.action]})}),(0,t.jsx)("div",{className:"w-6 h-6 bg-green-100 text-green-700 rounded flex items-center justify-center",children:(0,t.jsx)(N.A,{className:"h-3 w-3"})})]},e.permissionId))})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"All Permissions"}),(0,t.jsx)("div",{className:"space-y-1 max-h-96 overflow-y-auto",children:i.map(e=>{var s;return(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded-md",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-900",children:[e.resource.replace("-"," ")," - ",e.action]}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"role"===e.origin?"From role: ".concat(null==(s=e.roleNames)?void 0:s.join(", ")):"override"===e.origin?"User override":"Not granted"})]}),(0,t.jsx)("button",{onClick:()=>n(e.permissionId),className:"w-6 h-6 rounded flex items-center justify-center border transition-colors ".concat("allow"===e.state?"override"===e.origin?"bg-green-500 text-white border-green-600":"bg-green-100 text-green-700 border-green-200":"deny"===e.state?"override"===e.origin?"bg-red-500 text-white border-red-600":"bg-red-100 text-red-700 border-red-200":"bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200"),children:"allow"===e.state?(0,t.jsx)(N.A,{className:"h-3 w-3"}):"deny"===e.state?(0,t.jsx)(w.A,{className:"h-3 w-3"}):(0,t.jsx)(E.A,{className:"h-3 w-3"})})]},e.permissionId)})})]}),(0,t.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,t.jsx)("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"Bulk Actions"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsx)("button",{onClick:()=>{i.forEach(e=>{"allow"!==e.state&&n(e.permissionId)})},className:"px-3 py-2 text-xs bg-green-100 text-green-700 rounded-md hover:bg-green-200",children:"Grant All"}),(0,t.jsx)("button",{onClick:()=>{i.forEach(e=>{"deny"!==e.state&&n(e.permissionId)})},className:"px-3 py-2 text-xs bg-red-100 text-red-700 rounded-md hover:bg-red-200",children:"Deny All"}),(0,t.jsx)("button",{onClick:()=>{o.forEach(e=>{l(e.permissionId)})},className:"px-3 py-2 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 col-span-2",disabled:0===o.length,children:"Clear All Overrides"})]})]})]}):(0,t.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(v.A,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),(0,t.jsx)("h3",{className:"text-sm font-medium text-gray-900",children:"No user selected"}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Click on a user to view their permissions"})]})})]})]})}var T=r(2099);class G{static async listTenants(){try{let{data:e,error:s}=await T.ND.from("tenants").select("id, name").eq("status","active").order("name");if(s)throw s;return e||[]}catch(e){throw console.error("Error listing tenants:",e),e}}static async listTenantUsers(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let{page:r=1,limit:t=50,search:a}=s,i=(r-1)*t,n=T.ND.from("tenant_users").select("\n          user_id,\n          role,\n          is_active,\n          profiles!inner(\n            id,\n            email,\n            full_name\n          )\n        ").eq("tenant_id",e);a&&(n=n.or("profiles.email.ilike.%".concat(a,"%,profiles.first_name.ilike.%").concat(a,"%,profiles.last_name.ilike.%").concat(a,"%")));let{count:l}=await T.ND.from("tenant_users").select("*",{count:"exact",head:!0}).eq("tenant_id",e),{data:c,error:o}=await n.range(i,i+t-1).order("profiles(email)");if(o)throw o;return{users:(null==c?void 0:c.map(e=>{var s,r,t,a;return{userId:e.user_id,email:(null==(s=e.profiles)?void 0:s.email)||"unknown@example.com",display_name:(null==(r=e.profiles)?void 0:r.first_name)&&(null==(t=e.profiles)?void 0:t.last_name)?"".concat(e.profiles.first_name," ").concat(e.profiles.last_name):(null==(a=e.profiles)?void 0:a.email)||"Unknown User",role:e.role,is_active:e.is_active}}))||[],total:l||0}}catch(e){throw console.error("Error listing tenant users:",e),e}}static async listPermissionCatalog(){let e=[];return Object.values(i.Gv).forEach(s=>{Object.values(i.Jj).forEach(r=>{e.push({resource:s,action:r,permissionId:"".concat(s,":").concat(r),description:"".concat(r.charAt(0).toUpperCase()+r.slice(1)," ").concat(s.replace("-"," "))})})}),e}static async getEffectivePermissions(e,s){try{let r=await this.listPermissionCatalog(),t=new Map;for(let a of s){let s=await this.getUserDetail(e,a),i=[];for(let e of r){let r=await this.calculateEffectivePermission(s,e.permissionId,e.resource,e.action);i.push(r)}t.set(a,i)}return t}catch(e){throw console.error("Error getting effective permissions:",e),e}}static async getUserDetail(e,s){try{let{data:r,error:t}=await T.ND.from("profiles").select("*").eq("id",s).single();if(t)throw t;let{data:a,error:i}=await T.ND.from("tenant_users").select("role, is_active, tenant_id").eq("user_id",s).eq("tenant_id",e).single();if(i)throw i;let n=[];try{let{data:r}=await T.ND.from("user_tenant_permissions").select("permission_id, effect").eq("user_id",s).eq("tenant_id",e);n=(null==r?void 0:r.map(e=>({permissionId:e.permission_id,effect:e.effect})))||[]}catch(e){}return{profile:{...r,role:a.role},membership:{role:a.role,is_active:a.is_active,tenant_id:a.tenant_id},overrides:n,roles:[a.role]}}catch(e){throw console.error("Error getting user detail:",e),e}}static async calculateEffectivePermission(e,s,r,t){let a=e.overrides.find(e=>e.permissionId===s);return a?{permissionId:s,resource:r,action:t,state:a.effect,origin:"override",roleNames:e.roles}:this.checkRolePermission(e.membership.role,r,t)?{permissionId:s,resource:r,action:t,state:"allow",origin:"role",roleNames:[e.membership.role]}:{permissionId:s,resource:r,action:t,state:"none",origin:"none",roleNames:e.roles}}static checkRolePermission(e,s,r){return"host_admin"===e||("client_admin"===e?!["tenant-management","system-settings"].includes(s):"program_manager"===e?["project-management","work-requests","project-charter","risk-management"].includes(s)&&["view","create","update"].includes(r):"client_user"===e&&["work-requests","reporting"].includes(s)&&["view","create"].includes(r))}static async applyChanges(e){try{let{data:s,error:r}=await T.ND.rpc("apply_rbac_changes",{p_tenant_id:e.tenantId,p_actor_user_id:e.actorUserId,p_role_assignments:e.roleAssignments||[],p_user_overrides:e.userOverrides||[],p_audit_note:e.auditNote||"RBAC changes applied via admin interface"});if(r)return console.error("Error applying RBAC changes:",r),{success:!1,error:r.message};return{success:!0}}catch(e){return console.error("Error applying RBAC changes:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}static async getAuditLog(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;try{let{data:r,error:t}=await T.ND.from("activity_log").select("\n          *,\n          profiles!activity_log_user_id_fkey(full_name, email)\n        ").eq("tenant_id",e).in("action",["rbac_role_assigned","rbac_role_removed","rbac_override_set","rbac_override_cleared"]).order("timestamp",{ascending:!1}).limit(s);if(t)throw t;return r||[]}catch(e){return console.error("Error getting audit log:",e),[]}}}var O=r(5552),J=r(92);function M(){let[e,s]=(0,a.useState)([]),[r,n]=(0,a.useState)(null),[l,c]=(0,a.useState)("users"),[o,m]=(0,a.useState)(""),[u,x]=(0,a.useState)([]),[h,p]=(0,a.useState)([]),[j,b]=(0,a.useState)(null),[v,y]=(0,a.useState)(null),[N,w]=(0,a.useState)([]),[E,_]=(0,a.useState)(!1),[A,C]=(0,a.useState)(!1),[k,T]=(0,a.useState)(!1),[M,D]=(0,a.useState)(new Map),[W,P]=(0,a.useState)([]),{currentUserId:U,currentTenantId:V,isHostAdmin:q,canManage:z}=(0,i.Sk)();(0,a.useEffect)(()=>{B()},[]),(0,a.useEffect)(()=>{r&&L()},[r,o]),(0,a.useEffect)(()=>{K()},[]),(0,a.useEffect)(()=>{j&&r&&F()},[j,r]);let B=async()=>{try{let e=await G.listTenants();if(s(e),e.length>0){let s=V&&e.find(e=>e.id===V)||e[0];n(s)}}catch(e){console.error("Error loading tenants:",e)}},L=async()=>{if(r){C(!0);try{let{users:e}=await G.listTenantUsers(r.id,{search:o||void 0,limit:100}),s=e.map(e=>e.userId),t=await G.getEffectivePermissions(r.id,s),a=e.map(e=>({userId:e.userId,email:e.email,display_name:e.display_name,role:e.role,is_active:e.is_active,cells:t.get(e.userId)||[]}));x(a)}catch(e){console.error("Error loading tenant users:",e)}finally{C(!1)}}},K=async()=>{try{let e=await G.listPermissionCatalog();p(e)}catch(e){console.error("Error loading permission catalog:",e)}},F=async()=>{if(j&&r){T(!0);try{let e=await G.getUserDetail(r.id,j);y(e);let s=u.find(e=>e.userId===j);w((null==s?void 0:s.cells)||[])}catch(e){console.error("Error loading user detail:",e)}finally{T(!1)}}},Q=(0,a.useCallback)((e,s)=>{let r,t="".concat(e,":").concat(s),a=M.get(t),i=u.find(s=>s.userId===e),n=null==i?void 0:i.cells.find(e=>e.permissionId===s);switch(a||(null==n?void 0:n.state)||"none"){case"none":default:r="allow";break;case"allow":r="deny";break;case"deny":r="none"}let l=new Map(M);r===((null==n?void 0:n.state)||"none")?l.delete(t):l.set(t,r),D(l);let c={op:"none"===r?"clearOverride":"setOverride",userId:e,permissionId:s,effect:"none"===r?void 0:r};P(r=>[...r.filter(r=>r.userId!==e||r.permissionId!==s),c])},[M,u]),H=(0,a.useCallback)(e=>{b(e),_(!0)},[]),Y=(0,a.useCallback)(e=>{j&&Q(j,e)},[j,Q]),$=(0,a.useCallback)(e=>{if(j){let s="".concat(j,":").concat(e),r=new Map(M);r.delete(s),D(r);let t={op:"clearOverride",userId:j,permissionId:e};P(s=>[...s.filter(s=>s.userId!==j||s.permissionId!==e),t])}},[j,M]),X=async()=>{if(r&&U&&0!==W.length){C(!0);try{let e={tenantId:r.id,actorUserId:U,userOverrides:W.filter(e=>"setOverride"===e.op||"clearOverride"===e.op).map(e=>({userId:e.userId,permissionId:e.permissionId,effect:e.effect||null})),auditNote:"RBAC changes applied via admin interface: ".concat(W.length," operations")},s=await G.applyChanges(e);s.success?(D(new Map),P([]),await L(),j&&await F()):console.error("Failed to apply changes:",s.error)}catch(e){console.error("Error applying changes:",e)}finally{C(!1)}}},Z=W.length>0;return(0,t.jsx)(d,{children:(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,t.jsx)("div",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,t.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"RBAC Matrix"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Manage user permissions and access control across tenants"})]}),Z&&(0,t.jsxs)("div",{className:"flex items-center space-x-3 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2",children:[(0,t.jsx)(S.A,{className:"h-5 w-5 text-blue-600"}),(0,t.jsxs)("span",{className:"text-sm font-medium text-blue-900",children:[W.length," pending change",1!==W.length?"s":""]}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsxs)("button",{onClick:()=>{D(new Map),P([])},className:"px-3 py-1 text-xs bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50",children:[(0,t.jsx)(O.A,{className:"h-3 w-3 mr-1 inline"}),"Discard"]}),(0,t.jsxs)("button",{onClick:X,disabled:A,className:"px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50",children:[(0,t.jsx)(J.A,{className:"h-3 w-3 mr-1 inline"}),"Apply Changes"]})]})]})]})})}),(0,t.jsx)(g,{tenants:e,selectedTenant:r,onTenantChange:n,searchTerm:o,onSearchChange:m,loading:A}),(0,t.jsx)(f,{activeEntity:l,onEntityChange:c,userCount:u.length,roleCount:4}),(0,t.jsx)("div",{className:"p-6",children:r?(0,t.jsx)("div",{className:"space-y-6",children:(0,t.jsx)(I,{users:u,permissionCatalog:h,onCellClick:Q,onUserClick:H,loading:A,draftChanges:M})}):(0,t.jsxs)("div",{className:"text-center py-12",children:[(0,t.jsx)(S.A,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,t.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No tenant selected"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Select a tenant to manage user permissions and access control."})]})}),(0,t.jsx)(R,{isOpen:E,onClose:()=>_(!1),userDetail:v,userPermissions:N,onPermissionToggle:Y,onRevertOverride:$,loading:k})]})})}},6084:(e,s,r)=>{Promise.resolve().then(r.bind(r,1230))}},e=>{var s=s=>e(e.s=s);e.O(0,[2354,4173,2099,4660,8441,1684,7358],()=>s(6084)),_N_E=e.O()}]);