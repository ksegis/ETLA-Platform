(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6769],{447:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>o});var r=s(5155),a=s(2115),n=s(5695),i=s(2099);function o(){let e=(0,n.useRouter)();return(0,a.useEffect)(()=>{(async()=>{try{let{data:o,error:l}=await i.ND.auth.getSession();if(l){console.error("Auth callback error:",l),e.push("/login?error="+encodeURIComponent(l.message));return}if(o.session){let{data:l}=await i.ND.from("profiles").select("*").eq("id",o.session.user.id).single();if(l){await i.ND.from("profiles").update({last_login:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",o.session.user.id),await i.ND.from("tenant_users").update({last_login_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("user_id",o.session.user.id);let{data:e}=await i.ND.from("profiles").select("tenant_id").eq("id",o.session.user.id).single();(null==e?void 0:e.tenant_id)&&await i.ND.from("audit_logs").insert({user_id:o.session.user.id,tenant_id:e.tenant_id,action:"user_login",resource_type:"session",resource_id:o.session.user.id,details:{method:"google_oauth",email:o.session.user.email},ip_address:null,user_agent:navigator.userAgent,created_at:new Date().toISOString()})}else{let{data:l}=await i.ND.from("tenants").select("id, name").eq("is_active",!0).limit(1).single();if(!l){console.error("No active tenant found for new Google user"),e.push("/login?error="+encodeURIComponent("No tenant available for new users"));return}try{var t,s,r,a,n;let{error:e}=await i.ND.from("profiles").insert({id:o.session.user.id,full_name:(null==(t=o.session.user.user_metadata)?void 0:t.full_name)||(null==(s=o.session.user.user_metadata)?void 0:s.name)||"Google User",phone:null,department:null,job_title:"User",avatar_url:null==(r=o.session.user.user_metadata)?void 0:r.avatar_url,email:o.session.user.email,role:"user",role_level:"sub_client",tenant_id:l.id,is_active:!0,can_invite_users:!1,can_manage_sub_clients:!1,permission_scope:"own",last_login:new Date().toISOString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(e)throw console.error("Profile creation error:",e),e;let{error:u}=await i.ND.from("tenant_users").insert({tenant_id:l.id,user_id:o.session.user.id,role:"user",permissions:["read"],is_active:!0,role_level:"sub_client",can_invite_users:!1,can_manage_sub_clients:!1,permission_scope:"own",feature_permissions:{},last_login_at:new Date().toISOString(),mfa_enabled:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(u)throw console.error("Tenant user creation error:",u),u;let{error:d}=await i.ND.from("user_invitations").insert({email:o.session.user.email,invited_by:null,tenant_id:l.id,role:"user",status:"accepted",expires_at:new Date(Date.now()+2592e6).toISOString(),accepted_at:new Date().toISOString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select();d&&!d.message.includes("does not exist")&&console.error("Invitation record creation error:",d);let{error:c}=await i.ND.from("audit_logs").insert({user_id:o.session.user.id,tenant_id:l.id,action:"user_created",resource_type:"user",resource_id:o.session.user.id,details:{method:"google_oauth",email:o.session.user.email,full_name:(null==(a=o.session.user.user_metadata)?void 0:a.full_name)||(null==(n=o.session.user.user_metadata)?void 0:n.name),tenant_assigned:l.name},ip_address:null,user_agent:navigator.userAgent,created_at:new Date().toISOString()});c&&!c.message.includes("does not exist")&&console.error("Audit log creation error:",c),console.log("Complete user record created successfully for Google OAuth user")}catch(e){console.error("Failed to create complete user record:",e)}}e.push("/dashboard")}else e.push("/login")}catch(t){console.error("Auth callback exception:",t),e.push("/login?error="+encodeURIComponent("Authentication failed"))}})()},[e]),(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,r.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Completing sign-in..."}),(0,r.jsx)("p",{className:"text-gray-600",children:"Please wait while we set up your account."})]})})}},5695:(e,t,s)=>{"use strict";var r=s(8999);s.o(r,"usePathname")&&s.d(t,{usePathname:function(){return r.usePathname}}),s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})},6387:(e,t,s)=>{Promise.resolve().then(s.bind(s,447))}},e=>{var t=t=>e(e.s=t);e.O(0,[2354,2099,8441,1684,7358],()=>t(6387)),_N_E=e.O()}]);